<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pátio Digital 116ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-800 pb-32">

    <header class="bg-slate-900 text-white sticky top-0 z-40 shadow-xl border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/50">
                    <i class="ph-bold ph-police-car text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide">PÁTIO DIGITAL</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">116ª Circunscrição</p>
                </div>
            </div>
            <div class="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-xs font-bold text-slate-300">SISTEMA ATIVO</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6">

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <p class="text-xs font-bold text-slate-400 uppercase">Total Geral</p>
                    <i class="ph-duotone ph-car text-2xl text-slate-300"></i>
                </div>
                <p class="text-3xl font-black text-slate-800" id="stat-total">-</p>
            </div>
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-red-500 flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <p class="text-xs font-bold text-red-400 uppercase">No Pátio</p>
                    <i class="ph-duotone ph-lock-key text-2xl text-red-200"></i>
                </div>
                <p class="text-3xl font-black text-red-600" id="stat-patio">-</p>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500 flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <p class="text-xs font-bold text-green-400 uppercase">Liberados</p>
                    <i class="ph-duotone ph-check-circle text-2xl text-green-200"></i>
                </div>
                <p class="text-3xl font-black text-green-600" id="stat-liberado">-</p>
            </div>

            <div onclick="abrirForm()" class="bg-blue-600 cursor-pointer hover:bg-blue-700 transition p-5 rounded-2xl shadow-lg shadow-blue-200 flex flex-col justify-center items-center text-white group relative overflow-hidden">
                <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition duration-300"></div>
                <i class="ph-bold ph-plus text-3xl mb-2 group-hover:scale-110 transition"></i>
                <p class="font-bold text-sm z-10">Adicionar Veículo</p>
            </div>
        </div>

        <div class="relative mb-8 group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="ph-bold ph-magnifying-glass text-slate-400 text-xl group-focus-within:text-blue-500 transition"></i>
            </div>
            <input type="text" id="busca" onkeyup="filtrar()" 
                class="w-full pl-12 pr-4 py-4 rounded-xl border-none shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-lg transition bg-white placeholder:text-slate-400" 
                placeholder="Pesquisar por NIBA, Placa, Modelo ou Infração...">
        </div>

        <div id="grid-veiculos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-20 opacity-50">
                <i class="ph-duotone ph-spinner animate-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-slate-500 font-medium">Carregando base de dados...</p>
            </div>
        </div>

    </main>

    <div id="modal-form" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="fecharForm()"></div>
        <div class="absolute inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl overflow-y-auto fade-in flex flex-col">
            
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-10">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="ph-duotone ph-file-plus text-blue-600"></i> Novo Registro
                </h2>
                <button onclick="fecharForm()" class="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-8 flex-grow">
                <section>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center"><i class="ph-bold ph-identification-card"></i></span>
                        Identificação
                    </h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <label class="text-xs font-bold text-blue-600 mb-1 block">NIBA / ID PCPE</label>
                            <input type="text" id="in-niba" class="w-full bg-white p-3 rounded-lg border border-blue-200 outline-none font-mono text-lg font-bold text-slate-700 placeholder:font-normal" placeholder="Ex: 0323012774-0">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">PLACA *</label>
                            <input type="text" id="in-placa" class="w-full p-4 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none font-black text-3xl uppercase tracking-[0.2em] text-center text-slate-800" placeholder="ABC1234">
                        </div>
                    </div>
                </section>
                <hr class="border-slate-100">
                <section>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded bg-slate-100 text-slate-600 flex items-center justify-center"><i class="ph-bold ph-car"></i></span>
                        Detalhes do Veículo
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">TIPO</label>
                            <select id="in-tipo" class="w-full p-3 rounded-lg border border-slate-200 bg-white outline-none font-medium">
                                <option value="Motocicleta">Motocicleta</option>
                                <option value="Automovel">Automóvel</option>
                                <option value="Utilitario">Utilitário</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">COR</label>
                            <input type="text" id="in-cor" class="w-full p-3 rounded-lg border border-slate-200 outline-none" placeholder="Ex: Prata">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">MARCA</label>
                            <input type="text" id="in-marca" class="w-full p-3 rounded-lg border border-slate-200 outline-none" placeholder="Ex: Honda">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">MODELO</label>
                            <input type="text" id="in-modelo" class="w-full p-3 rounded-lg border border-slate-200 outline-none" placeholder="Ex: CG 160 Fan">
                        </div>
                    </div>
                </section>
                <hr class="border-slate-100">
                <section>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded bg-red-100 text-red-600 flex items-center justify-center"><i class="ph-bold ph-gavel"></i></span>
                        Jurídico
                    </h3>
                    <div class="mb-4">
                        <label class="text-xs font-bold text-red-500 mb-1 block flex items-center gap-1"><i class="ph-fill ph-siren"></i> INFRAÇÃO PENAL</label>
                        <input type="text" id="in-infracao" class="w-full p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 font-bold outline-none placeholder:font-normal placeholder:text-red-300" placeholder="Ex: Roubo, Tráfico, Homicídio...">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">Nº BOE / VPI</label>
                            <input type="text" id="in-boe" class="w-full p-3 rounded-lg border border-slate-200 outline-none" placeholder="Procedimento Policial">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 mb-1 block">Nº PROCESSO</label>
                            <input type="text" id="in-processo" class="w-full p-3 rounded-lg border border-slate-200 outline-none" placeholder="Processo Judicial">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-slate-600 mb-1 block">OBSERVAÇÕES</label>
                            <textarea id="in-obs" rows="3" class="w-full p-3 rounded-lg border border-slate-200 outline-none" placeholder="Avarias, local exato, detalhes..."></textarea>
                        </div>
                    </div>
                </section>
                <section>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded bg-slate-100 text-slate-600 flex items-center justify-center"><i class="ph-bold ph-camera"></i></span>
                        Registro Fotográfico
                    </h3>
                    <input type="text" id="in-foto" class="w-full p-3 rounded-lg border border-slate-200 outline-none text-sm font-mono text-slate-500" placeholder="Cole o Link (URL) da imagem aqui">
                </section>
            </div>

            <div class="p-6 border-t border-slate-100 bg-slate-50 flex gap-3 sticky bottom-0 z-10">
                <button onclick="fecharForm()" class="flex-1 py-4 rounded-xl font-bold text-slate-500 hover:bg-white hover:shadow border border-transparent hover:border-slate-200 transition">Cancelar</button>
                <button onclick="salvar()" class="flex-[2] py-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform hover:scale-[1.01] flex items-center justify-center gap-2">
                    <i class="ph-bold ph-floppy-disk"></i> SALVAR REGISTRO
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  ⚠️ SUAS CHAVES JÁ CONFIGURADAS ⚠️
        // ==========================================
        const SUPABASE_URL = 'https://newbrgjewjnebfnhumci.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ld2JyZ2pld2puZWJmbmh1bWNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDcyMTAsImV4cCI6MjA4MTEyMzIxMH0.Z_AE5HnKxIwNni9RXgI1aGViJX2v_4Z0Nd5uMEqIue4';
        // ==========================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function carregar() {
            const { data, error } = await supabase.from('veiculos').select('*').order('id', { ascending: false });
            if(error) { 
                console.error(error); 
                alert("Erro de conexão! Verifique se você rodou o comando SQL no Supabase para liberar o RLS."); 
                return; 
            }
            atualizarDashboard(data);
            renderizarCards(data);
        }

        function atualizarDashboard(data) {
            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-patio').innerText = data.filter(v => v.status === 'No Pátio').length;
            document.getElementById('stat-liberado').innerText = data.filter(v => v.status === 'Liberado').length;
        }

        function renderizarCards(lista) {
            const grid = document.getElementById('grid-veiculos');
            grid.innerHTML = '';
            lista.forEach(v => {
                const isPatio = v.status === 'No Pátio';
                const statusColor = isPatio ? 'bg-red-500 text-white' : 'bg-green-500 text-white';
                const statusIcon = isPatio ? 'ph-lock-key' : 'ph-check';
                const img = v.foto_url || 'https://placehold.co/600x400/f1f5f9/94a3b8?text=Sem+Foto';
                
                const card = `
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 overflow-hidden group item-veiculo flex flex-col h-full relative">
                    <div class="h-56 bg-slate-100 relative overflow-hidden shrink-0">
                        <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500 cursor-pointer" onclick="window.open('${img}')">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-80"></div>
                        <span class="absolute top-3 right-3 ${statusColor} text-[10px] font-bold px-3 py-1.5 rounded-full shadow-sm flex items-center gap-1 z-10">
                            <i class="ph-bold ${statusIcon}"></i> ${v.status.toUpperCase()}
                        </span>
                        ${v.niba ? `<span class="absolute top-3 left-3 bg-white/95 backdrop-blur text-blue-900 text-[11px] font-mono font-bold px-2 py-1 rounded border border-blue-100 z-10 shadow-sm flex items-center gap-1"><i class="ph-bold ph-hash"></i> ${v.niba}</span>` : ''}
                        <div class="absolute bottom-3 left-3 text-white z-10">
                            <p class="text-[10px] opacity-80 uppercase tracking-widest font-bold mb-0.5">${v.marca || 'Marca n/i'}</p>
                            <h3 class="text-2xl font-black tracking-tight leading-none text-white">${v.placa}</h3>
                        </div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-sm font-bold text-slate-600 flex items-center gap-1">${v.modelo || 'Modelo não inf.'}</p>
                            <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded uppercase">${v.cor || 'N/I'}</span>
                        </div>
                        ${v.infracao ? `<div class="bg-red-50 border border-red-100 rounded-lg p-2.5 mb-4 flex items-start gap-2"><i class="ph-fill ph-siren text-red-500 mt-0.5"></i><div><p class="text-[10px] font-bold text-red-400 uppercase leading-none mb-1">Infração Relacionada</p><p class="text-xs font-bold text-red-700 uppercase leading-tight">${v.infracao}</p></div></div>` : ''}
                        <div class="grid grid-cols-2 gap-y-3 text-xs text-slate-500 border-t border-slate-100 pt-4 mt-auto">
                            <div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1"><i class="ph-bold ph-file-text"></i> Processo</span><span class="font-bold text-slate-700 truncate" title="${v.processo}">${v.processo || '-'}</span></div>
                            <div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1"><i class="ph-bold ph-police-car"></i> BOE / VPI</span><span class="font-bold text-slate-700 truncate" title="${v.boe}">${v.boe || '-'}</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-5 pt-4 border-t border-dashed border-slate-200">
                            ${isPatio 
                                ? `<button onclick="alterarStatus(${v.id}, 'Liberado')" class="bg-green-50 hover:bg-green-100 text-green-700 text-xs font-bold py-3 rounded-xl transition border border-green-200 flex items-center justify-center gap-1.5"><i class="ph-bold ph-key"></i> LIBERAR</button>` 
                                : `<button class="bg-slate-50 text-slate-400 text-xs font-bold py-3 rounded-xl cursor-not-allowed border border-slate-100 flex items-center justify-center gap-1.5"><i class="ph-bold ph-check"></i> ENTREGUE</button>`
                            }
                            <button onclick="excluir(${v.id})" class="bg-white hover:bg-red-50 text-red-300 hover:text-red-500 text-xs font-bold py-3 rounded-xl transition border border-slate-200 flex items-center justify-center gap-1.5"><i class="ph-bold ph-trash"></i> EXCLUIR</button>
                        </div>
                    </div>
                </div>`;
                grid.innerHTML += card;
            });
        }

        async function salvar() {
            const dados = {
                placa: document.getElementById('in-placa').value.toUpperCase(),
                niba: document.getElementById('in-niba').value,
                infracao: document.getElementById('in-infracao').value,
                tipo: document.getElementById('in-tipo').value,
                cor: document.getElementById('in-cor').value,
                marca: document.getElementById('in-marca').value,
                modelo: document.getElementById('in-modelo').value,
                boe: document.getElementById('in-boe').value,
                processo: document.getElementById('in-processo').value,
                observacoes: document.getElementById('in-obs').value,
                foto_url: document.getElementById('in-foto').value,
                status: 'No Pátio'
            };

            if(!dados.placa) return alert("Erro: O campo PLACA é obrigatório!");

            const { error } = await supabase.from('veiculos').insert([dados]);
            if(!error) {
                fecharForm();
                limparForm();
                carregar();
            } else {
                alert("Erro ao salvar: " + error.message);
            }
        }

        async function alterarStatus(id, st) {
            if(confirm("Deseja marcar este veículo como LIBERADO?")) {
                await supabase.from('veiculos').update({status: st}).eq('id', id);
                carregar();
            }
        }
        
        async function excluir(id) {
            if(confirm("ATENÇÃO: Tem certeza que deseja excluir este registro permanentemente?")) {
                await supabase.from('veiculos').delete().eq('id', id);
                carregar();
            }
        }

        function filtrar() {
            const termo = document.getElementById('busca').value.toLowerCase();
            document.querySelectorAll('.item-veiculo').forEach(el => {
                const texto = el.innerText.toLowerCase();
                el.style.display = texto.includes(termo) ? 'flex' : 'none';
            });
        }

        function abrirForm() { document.getElementById('modal-form').classList.remove('hidden'); }
        function fecharForm() { document.getElementById('modal-form').classList.add('hidden'); }
        function limparForm() {
            ['in-placa','in-niba','in-infracao','in-cor','in-marca','in-modelo','in-boe','in-processo','in-obs','in-foto']
            .forEach(id => document.getElementById(id).value = '');
        }

        carregar();
    </script>
</body>
</html>