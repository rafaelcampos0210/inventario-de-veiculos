<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SGP - Sistema Policial</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scroll::-webkit-scrollbar { display: none; }
        #conteudo-principal { display: none; } 
        .modal-up { animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .input-box { width: 100%; background: transparent; border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; font-size: 0.95rem; color: #1e293b; font-weight: 500; }
        .input-box:read-only { background-color: #f1f5f9; border-color: transparent; color: #64748b; }
        .editing .input-box { background-color: #fff; border-color: #2563eb; box-shadow: 0 0 0 1px #2563eb; }
        .btn-trash { display: none !important; }
        .editing .btn-trash { display: flex !important; }
        .filter-btn.active { background-color: #1e293b; color: white; border-color: #1e293b; }
    </style>
</head>
<body class="text-slate-800 pb-32">

    <div id="tela-loading" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center z-[999] text-white">
        <i class="ph-bold ph-spinner animate-spin text-4xl mb-4 text-orange-500"></i>
        <p class="text-xs font-bold tracking-widest uppercase">Conectando ao Google...</p>
    </div>

    <div id="conteudo-principal">
        <header class="bg-slate-900 text-white sticky top-0 z-40 shadow-xl border-b border-slate-700">
            <div class="max-w-4xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg"><i class="ph-bold ph-police-car text-xl text-blue-400"></i></div>
                    <div><h1 class="text-sm font-black tracking-widest uppercase">P√°tio 116¬™ DP</h1><p class="text-[10px] text-slate-400">Firebase System</p></div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-backup" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-600 flex gap-2 items-center transition" title="Gerar Planilha"><i class="ph-bold ph-table text-lg"></i> <span class="hidden sm:inline">GERAR PLANILHA</span></button>
                    <button id="btn-novo" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold uppercase flex items-center gap-2 transition active:scale-95"><i class="ph-bold ph-plus"></i> Novo</button>
                    <button id="btn-sair" class="bg-red-900/50 hover:bg-red-800 text-white p-2 rounded-lg border border-red-900 transition"><i class="ph-bold ph-sign-out text-lg"></i></button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase">Total Geral</p><p class="text-2xl font-black text-slate-800 mt-1" id="stat-total">-</p></div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm"><p class="text-[10px] font-bold text-red-500 uppercase">No P√°tio</p><p class="text-2xl font-black text-slate-800 mt-1" id="stat-patio">-</p></div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-emerald-500 shadow-sm"><p class="text-[10px] font-bold text-emerald-600 uppercase">Liberados</p><p class="text-2xl font-black text-slate-800 mt-1" id="stat-liberado">-</p></div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-yellow-400 shadow-sm"><p class="text-[10px] font-bold text-yellow-600 uppercase">Auditados</p><div class="flex gap-1 mt-1"><span class="text-2xl font-black text-slate-800" id="stat-audit">-</span><span class="text-xs font-bold text-slate-400" id="stat-audit-perc">%</span></div></div>
            </div>

            <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scroll" id="area-filtros">
                <button data-filter="todos" class="filter-btn active px-4 py-2 rounded-full text-xs font-bold uppercase border border-slate-300 bg-white text-slate-600 whitespace-nowrap transition shadow-sm">Todos</button>
                <button data-filter="patio" class="filter-btn px-4 py-2 rounded-full text-xs font-bold uppercase border border-red-200 bg-red-50 text-red-600 whitespace-nowrap transition shadow-sm">üîí S√≥ Apreendidos</button>
                <button data-filter="liberado" class="filter-btn px-4 py-2 rounded-full text-xs font-bold uppercase border border-emerald-200 bg-emerald-50 text-emerald-600 whitespace-nowrap transition shadow-sm">‚úÖ S√≥ Liberados</button>
                <button data-filter="pendente" class="filter-btn px-4 py-2 rounded-full text-xs font-bold uppercase border border-yellow-200 bg-yellow-50 text-yellow-600 whitespace-nowrap transition shadow-sm">‚ö†Ô∏è Falta Auditar</button>
            </div>

            <div class="relative mb-6 group">
                <i class="ph-bold ph-magnifying-glass absolute left-4 top-3.5 text-slate-400 group-focus-within:text-blue-600 transition"></i>
                <input type="text" id="campo-busca" class="w-full pl-11 pr-4 py-3 bg-white border-none rounded-xl shadow-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-600 font-medium placeholder:text-slate-400 transition" placeholder="Pesquisar Placa, BOE, Cor, Processo...">
            </div>

            <div id="lista-container" class="space-y-3 pb-10 text-center py-10 text-slate-400 text-xs font-bold uppercase animate-pulse">Carregando Banco de Dados...</div>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 z-[100] hidden flex flex-col">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" id="modal-overlay"></div>
        <div class="absolute inset-x-0 bottom-0 top-0 md:top-10 md:inset-x-auto md:right-0 md:w-[600px] bg-slate-50 md:rounded-l-2xl shadow-2xl overflow-hidden flex flex-col modal-up">
            <div class="bg-white px-5 py-3 border-b border-slate-200 flex justify-between items-center sticky top-0 z-10 shadow-sm">
                <button id="btn-fechar" class="text-slate-400 hover:text-slate-700 p-2 rounded-full hover:bg-slate-100 transition"><i class="ph-bold ph-x text-xl"></i></button>
                <span class="text-xs font-black text-slate-500 uppercase tracking-widest">PRONTU√ÅRIO</span>
                <button id="btn-editar" class="text-blue-600 bg-blue-50 border border-blue-100 px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2 active:scale-95 transition hover:bg-blue-100"><i class="ph-bold ph-pencil-simple"></i> Editar</button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 space-y-6 bg-slate-50" id="area-formulario">
                
                <div class="bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                    <button id="btn-auditoria" class="w-full py-4 rounded-lg font-bold uppercase text-xs tracking-widest flex items-center justify-center gap-3 transition active:scale-[0.98]"></button>
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between items-end px-1"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Fotos</label><label class="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer flex items-center gap-2 shadow hover:bg-slate-800 transition active:scale-95"><i class="ph-bold ph-camera text-lg"></i> Adicionar<input type="file" id="input-camera" accept="image/*" class="hidden"></label></div>
                    <div id="galeria" class="flex gap-3 overflow-x-auto pb-4 pt-1 px-1 no-scroll snap-x min-h-[110px]"></div>
                    <p id="status-upload" class="hidden text-center text-[10px] font-bold text-blue-600 animate-pulse bg-blue-50 py-2 rounded border border-blue-100">Enviando imagem...</p>
                </div>

                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-600"></div>
                    <div class="grid grid-cols-2 gap-5 mb-4"><div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Placa</label><input id="in-placa" class="input-box text-3xl font-mono font-black uppercase text-slate-900 tracking-widest p-0 border-none bg-transparent" readonly></div><div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">NIBA</label><input id="in-niba" class="input-box font-mono text-blue-600 font-bold bg-blue-50 border-blue-100" readonly></div></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Status Atual</label><select id="in-status" class="input-box font-bold bg-slate-100 border-transparent text-slate-700" disabled><option value="No P√°tio">üîí APREENDIDO (NO P√ÅTIO)</option><option value="Liberado">‚úÖ LIBERADO / ENTREGUE</option></select></div>
                </div>

                <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">Modelo</label><input id="in-modelo" class="input-box" readonly></div><div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">Marca</label><input id="in-marca" class="input-box" readonly></div><div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">Cor</label><input id="in-cor" class="input-box" readonly></div><div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">Tipo</label><input id="in-tipo" class="input-box" readonly></div></div>
                <div class="bg-red-50 p-3 rounded-lg border border-red-100"><label class="text-[10px] font-bold text-red-400 uppercase block mb-1">Infra√ß√£o Penal</label><input id="in-infracao" class="input-box text-red-700 font-bold bg-transparent border-none p-0 uppercase" readonly></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">BOE</label><input id="in-boe" class="input-box" readonly></div><div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">Processo / VPI</label><input id="in-processo" class="input-box" readonly></div></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1">Observa√ß√µes e Hist√≥rico</label><textarea id="in-obs" rows="5" class="input-box resize-none leading-relaxed" readonly></textarea></div>
                
                <div class="border-t border-slate-200 pt-4 mt-4">
                    <button id="btn-ver-historico" class="text-xs text-blue-600 font-bold hover:underline flex items-center gap-1"><i class="ph-bold ph-clock-counter-clockwise"></i> Ver Hist√≥rico de Altera√ß√µes</button>
                    <div id="lista-historico" class="hidden mt-3 space-y-2 text-[10px] text-slate-500 bg-slate-100 p-3 rounded-lg"></div>
                </div>
            </div>

            <div id="barra-acoes" class="p-5 bg-white border-t border-slate-200 hidden flex-col gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button id="btn-salvar" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-lg shadow-lg uppercase text-xs tracking-widest active:scale-[0.98] transition flex justify-center gap-2 items-center"><i class="ph-bold ph-floppy-disk text-lg"></i> SALVAR</button>
                <button id="btn-excluir" class="w-full bg-white border border-red-200 text-red-600 hover:bg-red-50 font-bold py-3 rounded-lg uppercase text-xs tracking-widest flex items-center justify-center gap-2 active:scale-[0.98] transition"><i class="ph-bold ph-trash text-lg"></i> EXCLUIR</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // SUA CONFIGURA√á√ÉO DO FIREBASE (J√Å INSERIDA)
        const firebaseConfig = {
            apiKey: "AIzaSyA-q94iSIsQuRl1xS1S8vw2RkDAxMzZoLk",
            authDomain: "sgp-patio.firebaseapp.com",
            projectId: "sgp-patio",
            storageBucket: "sgp-patio.firebasestorage.app",
            messagingSenderId: "264796636092",
            appId: "1:264796636092:web:91d69d0853df208c9761b9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let CACHE = [];
        let ATUAL = null;
        let ATUAL_ID = null;
        let EDITING = false;
        let FILTRO_ATUAL = 'todos';
        let USUARIO_EMAIL = '';

        // SEGURAN√áA E LOGIN
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
            else {
                USUARIO_EMAIL = user.email;
                document.getElementById('tela-loading').style.display = 'none';
                document.getElementById('conteudo-principal').style.display = 'block';
                carregarDados();
            }
        });

        document.getElementById('btn-sair').onclick = () => signOut(auth);

        // CRUD FIREBASE
        async function carregarDados() {
            try {
                // Tenta carregar ordenado (pode precisar de √≠ndice)
                // Se der erro de √≠ndice, carrega sem ordem e ordena no front
                try {
                    const q = query(collection(db, "veiculos"), orderBy("placa"));
                    const querySnapshot = await getDocs(q);
                    CACHE = [];
                    querySnapshot.forEach((doc) => { CACHE.push({ id: doc.id, ...doc.data() }); });
                } catch(errIdx) {
                    const querySnapshot = await getDocs(collection(db, "veiculos"));
                    CACHE = [];
                    querySnapshot.forEach((doc) => { CACHE.push({ id: doc.id, ...doc.data() }); });
                    CACHE.sort((a,b) => (a.placa || "").localeCompare(b.placa || ""));
                }
                atualizarInterface();
            } catch (e) {
                console.error(e);
                alert("Erro ao carregar dados. Verifique a internet.");
            }
        }

        async function registrarHistorico(acao, detalhes) {
            try {
                await addDoc(collection(db, "historico"), {
                    acao: acao, placa: ATUAL?.placa || 'N/A', usuario: USUARIO_EMAIL, detalhes: detalhes, data_hora: serverTimestamp()
                });
            } catch(e) { console.log("Erro log hist√≥rico:", e); }
        }

        // INTERFACE
        function atualizarInterface() {
            const total = CACHE.length;
            const patio = CACHE.filter(v => v.status === 'No P√°tio').length;
            const liberado = CACHE.filter(v => v.status === 'Liberado').length;
            const conferido = CACHE.filter(v => v.verificado && v.status === 'No P√°tio').length;
            const perc = patio > 0 ? Math.round((conferido / patio) * 100) : 0;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-patio').innerText = patio;
            document.getElementById('stat-liberado').innerText = liberado;
            document.getElementById('stat-audit').innerText = conferido + ` / ${patio}`;
            document.getElementById('stat-audit-perc').innerText = `(${perc}%)`;

            aplicarFiltros();
        }

        // BUSCA E FILTROS
        const botoesFiltro = document.querySelectorAll('.filter-btn');
        botoesFiltro.forEach(btn => btn.onclick = () => {
            botoesFiltro.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            FILTRO_ATUAL = btn.dataset.filter;
            aplicarFiltros();
        });

        document.getElementById('campo-busca').onkeyup = aplicarFiltros;

        function aplicarFiltros() {
            const termo = document.getElementById('campo-busca').value.toLowerCase();
            const filtrados = CACHE.filter(v => {
                const texto = (
                    (v.placa||'') + (v.modelo||'') + (v.boe||'') + (v.cor||'') + (v.processo||'')
                ).toLowerCase();
                
                if(!texto.includes(termo)) return false;
                if(FILTRO_ATUAL === 'patio' && v.status !== 'No P√°tio') return false;
                if(FILTRO_ATUAL === 'liberado' && v.status !== 'Liberado') return false;
                if(FILTRO_ATUAL === 'pendente' && (v.status !== 'No P√°tio' || v.verificado)) return false;
                return true;
            });
            desenharLista(filtrados);
        }

        function desenharLista(lista) {
            const container = document.getElementById('lista-container');
            container.innerHTML = '';
            if (lista.length === 0) { container.innerHTML = '<div class="text-center py-10 text-slate-400 font-bold">NENHUM REGISTRO</div>'; return; }
            
            lista.forEach(v => {
                const card = document.createElement('div');
                let borda = v.status === 'No P√°tio' ? (v.verificado ? 'border-emerald-500 border-l-4' : 'border-slate-200') : 'border-slate-200 opacity-70';
                let selo = v.verificado && v.status==='No P√°tio' ? '<div class="absolute right-0 top-0 bg-emerald-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg"><i class="ph-bold ph-check"></i> OK</div>' : '';
                
                card.className = `bg-white p-5 rounded-xl border ${borda} shadow-sm hover:shadow-md relative overflow-hidden group cursor-pointer`;
                card.innerHTML = `
                    ${selo}
                    <div class="flex justify-between items-start mb-2 mt-1"><h3 class="text-lg font-black text-slate-800 font-mono tracking-wide group-hover:text-blue-600 transition">${v.placa}</h3>${v.status !== 'No P√°tio' ? '<span class="text-[9px] font-bold bg-slate-100 px-1.5 rounded">LIBERADO</span>':''}</div>
                    <div class="text-xs font-bold text-slate-500 flex items-center gap-2 mb-3">${v.modelo||'N/I'}<span class="bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${v.cor||'COR N/I'}</span></div>
                    <div class="flex gap-2 pt-3 border-t border-slate-50">${v.boe ? `<span class="text-[9px] font-bold text-slate-400 bg-slate-50 px-1.5 rounded">BOE: ${v.boe}</span>`:''}</div>
                `;
                card.onclick = () => abrirModal(v);
                container.appendChild(card);
            });
        }

        // MODAL E EDI√á√ÉO
        function abrirModal(v) {
            ATUAL = v; ATUAL_ID = v.id; EDITING = false;
            atualizarModoEdicao(); renderBotaoAuditoria();
            ['placa','niba','status','modelo','marca','cor','tipo','infracao','boe','processo','obs'].forEach(k => {
                const key = k==='obs'?'observacoes':k;
                document.getElementById('in-'+k).value = v[key] || '';
            });
            renderGaleria();
            document.getElementById('lista-historico').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
        }

        function renderBotaoAuditoria() {
            const btn = document.getElementById('btn-auditoria');
            if(ATUAL.verificado) {
                btn.className = "w-full py-4 rounded-lg font-bold uppercase text-xs tracking-widest flex items-center justify-center gap-2 transition shadow-md bg-emerald-600 text-white hover:bg-emerald-700";
                btn.innerHTML = '<i class="ph-bold ph-check-circle text-xl"></i> CONFERIDO NO P√ÅTIO';
            } else {
                btn.className = "w-full py-4 rounded-lg font-bold uppercase text-xs tracking-widest flex items-center justify-center gap-2 transition shadow-md bg-slate-100 text-slate-400 hover:bg-slate-200 border border-slate-200";
                btn.innerHTML = '<i class="ph-bold ph-square text-xl"></i> MARCAR COMO CONFERIDO';
            }
        }

        window.alternarConferencia = async () => {
            ATUAL.verificado = !ATUAL.verificado;
            await updateDoc(doc(db, "veiculos", ATUAL_ID), { verificado: ATUAL.verificado });
            registrarHistorico('Auditoria', ATUAL.verificado ? 'Conferido' : 'Pendente');
            renderBotaoAuditoria(); carregarDados();
        }

        // BOT√ïES E A√á√ïES
        document.getElementById('btn-fechar').onclick = () => document.getElementById('modal').classList.add('hidden');
        document.getElementById('modal-overlay').onclick = () => document.getElementById('modal').classList.add('hidden');
        
        document.getElementById('btn-editar').onclick = () => { EDITING = !EDITING; atualizarModoEdicao(); };

        function atualizarModoEdicao() {
            const form = document.getElementById('area-formulario');
            const actions = document.getElementById('barra-acoes');
            const inputs = form.querySelectorAll('input:not([type=hidden]), select, textarea');
            if(EDITING) {
                form.classList.add('editing'); actions.classList.remove('hidden'); actions.classList.add('flex');
                document.getElementById('btn-editar').innerText = 'Cancelar';
                inputs.forEach(i => { if(i.id!=='in-placa') { i.removeAttribute('readonly'); i.removeAttribute('disabled'); }});
            } else {
                form.classList.remove('editing'); actions.classList.add('hidden');
                document.getElementById('btn-editar').innerHTML = '<i class="ph-bold ph-pencil-simple"></i> Editar';
                inputs.forEach(i => { i.setAttribute('readonly',true); if(i.tagName==='SELECT') i.setAttribute('disabled',true); });
            }
        }

        document.getElementById('btn-salvar').onclick = async () => {
            const up = {
                niba: document.getElementById('in-niba').value, status: document.getElementById('in-status').value, modelo: document.getElementById('in-modelo').value,
                marca: document.getElementById('in-marca').value, cor: document.getElementById('in-cor').value, tipo: document.getElementById('in-tipo').value,
                infracao: document.getElementById('in-infracao').value, boe: document.getElementById('in-boe').value, processo: document.getElementById('in-processo').value, observacoes: document.getElementById('in-obs').value
            };
            await updateDoc(doc(db, "veiculos", ATUAL_ID), up);
            registrarHistorico('Edi√ß√£o', 'Atualizou dados');
            alert("Salvo!"); document.getElementById('modal').classList.add('hidden'); carregarDados();
        }

        document.getElementById('btn-novo').onclick = async () => {
            const p = prompt("Placa do novo ve√≠culo:"); if(!p) return;
            // Cria um ID √∫nico usando timestamp
            const novo = { placa: p.toUpperCase(), status: 'No P√°tio', fotos: [], verificado: false, modelo: '', cor: '' };
            await addDoc(collection(db, "veiculos"), novo);
            await registrarHistorico('Cria√ß√£o', 'Novo ve√≠culo: ' + p);
            carregarDados();
        }

        document.getElementById('btn-excluir').onclick = async () => {
            if(!confirm("Excluir definitivamente?")) return;
            await deleteDoc(doc(db, "veiculos", ATUAL_ID));
            registrarHistorico('Exclus√£o', 'Excluiu ' + ATUAL.placa);
            document.getElementById('modal').classList.add('hidden'); carregarDados();
        }

        // FOTOS (STORAGE)
        function renderGaleria() {
            const div = document.getElementById('galeria'); div.innerHTML = '';
            (ATUAL.fotos || []).forEach((url, i) => {
                const img = document.createElement('div');
                img.className = "relative w-20 h-20 bg-slate-200 rounded shrink-0 border border-slate-300";
                img.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded cursor-pointer" onclick="window.open('${url}')"><button class="absolute top-0 right-0 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow" onclick="delFoto(${i})">x</button>`;
                div.appendChild(img);
            });
        }

        document.getElementById('input-camera').onchange = async (e) => {
            const file = e.target.files[0]; if(!file) return;
            document.getElementById('status-upload').classList.remove('hidden');
            const storageRef = ref(storage, 'fotos/' + ATUAL.placa + '_' + Date.now());
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            const novas = [...(ATUAL.fotos||[]), url];
            await updateDoc(doc(db, "veiculos", ATUAL_ID), { fotos: novas });
            registrarHistorico('Foto', 'Adicionou foto');
            ATUAL.fotos = novas; renderGaleria();
            document.getElementById('status-upload').classList.add('hidden');
        }

        window.delFoto = async (i) => {
            if(!confirm("Apagar foto?")) return;
            const novas = ATUAL.fotos.filter((_, idx) => idx !== i);
            await updateDoc(doc(db, "veiculos", ATUAL_ID), { fotos: novas });
            registrarHistorico('Foto', 'Apagou foto');
            ATUAL.fotos = novas; renderGaleria();
        }

        // EXCEL E HIST√ìRICO
        document.getElementById('btn-backup').onclick = async () => {
            if(!confirm("Gerar Planilha Completa?")) return;
            const dadosLimpos = CACHE.map(v => ({
                "PLACA": v.placa, "STATUS": v.status, "AUDITORIA": v.verificado?"OK":"-", "MODELO": v.modelo, "MARCA": v.marca, "COR": v.cor, "BOE": v.boe, "PROC": v.processo, "OBS": v.observacoes, "NIBA": v.niba
            }));
            const ws = XLSX.utils.json_to_sheet(dadosLimpos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario_Patio");
            
            // Tenta pegar hist√≥rico
            try {
                // Se der erro de √≠ndice no orderby, tenta sem
                try {
                    const qHist = query(collection(db, "historico"), orderBy("data_hora", "desc"));
                    const snapHist = await getDocs(qHist);
                    const histData = [];
                    snapHist.forEach(d => histData.push({ ...d.data(), data_hora: d.data().data_hora?.toDate ? d.data().data_hora.toDate().toLocaleString() : '-' }));
                    const wsHist = XLSX.utils.json_to_sheet(histData);
                    XLSX.utils.book_append_sheet(wb, wsHist, "Historico");
                } catch(e) {
                     const qHist = collection(db, "historico");
                     const snapHist = await getDocs(qHist);
                     const histData = [];
                     snapHist.forEach(d => histData.push(d.data()));
                     const wsHist = XLSX.utils.json_to_sheet(histData);
                     XLSX.utils.book_append_sheet(wb, wsHist, "Historico");
                }
            } catch(e){}

            XLSX.writeFile(wb, `SGP_Patio_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        document.getElementById('btn-ver-historico').onclick = async () => {
            const el = document.getElementById('lista-historico');
            if(!el.classList.contains('hidden')) { el.classList.add('hidden'); return; }
            el.innerHTML = 'Carregando...'; el.classList.remove('hidden');
            
            let hist = [];
            // Tenta trazer ordenado, se falhar (√≠ndice), traz tudo e filtra
            try {
                const q = query(collection(db, "historico"), orderBy("data_hora", "desc"));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => { const d = doc.data(); if(d.placa===ATUAL.placa) hist.push(d); });
            } catch (e) {
                const snapshot = await getDocs(collection(db, "historico"));
                snapshot.forEach(doc => { const d = doc.data(); if(d.placa===ATUAL.placa) hist.push(d); });
            }
            
            if(!hist.length) el.innerHTML = 'Nada recente.';
            else el.innerHTML = hist.slice(0,5).map(h => {
                const dataStr = h.data_hora?.toDate ? h.data_hora.toDate().toLocaleDateString('pt-BR') : '-';
                return `<div class="border-b pb-1 mb-1 text-[10px]"><span class="font-bold text-slate-700">${h.acao}</span> (${dataStr}) - ${h.usuario}</div>`;
            }).join('');
        }
    </script>
</body>
</html>
